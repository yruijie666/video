<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­£åœ¨æ’­æ”¾...</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“º</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ... (æ‰€æœ‰ CSS æ ·å¼ä¿æŒä¸å˜) ... */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f0f2f5; color: #333; line-height: 1.6; }
        .header { background-color: #ffffff; padding: 10px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .header .logo { font-size: 24px; font-weight: 700; color: #2a7aff; text-decoration: none; margin-right: 30px; }
        .header .search-form { flex-grow: 1; max-width: 600px; position: relative; display: flex; }
        .header .search-form input { width: 100%; padding: 8px 15px; border: 1px solid #e0e0e0; border-radius: 20px; outline: none; font-size: 1rem; background-color: #f7f7f7; }
        .header .search-form button { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px; color: #666; font-size: 1.1rem; }
        .header .user-section { display: flex; align-items: center; margin-left: 30px; }
        .header .user-section .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #ccc; margin-right: 10px; }
        .header .user-section span { font-weight: 500; color: #555; }
        .main-player-content { max-width: 1200px; margin: 25px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr; gap: 20px; }
        #player-container, #tags-section, #comments-section { background: #ffffff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 25px; }
        #video-title { font-size: 1.8rem; font-weight: 700; color: #222; margin-bottom: 15px; }
        #video-stats { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; font-size: 0.95rem; color: #777; margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; }
        #video-wrapper { position: relative; width: 100%; aspect-ratio: 16 / 9; background-color: #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        #video-wrapper video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        #video-description { font-size: 1rem; line-height: 1.7; color: #555; padding: 0 5px; }
        #tags-section h2, #comments-section h2 { font-size: 1.3rem; font-weight: 600; color: #333; margin-bottom: 15px; border-bottom: 2px solid #2a7aff; padding-bottom: 5px; display: inline-block; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .tag { background-color: #eef4ff; color: #2a7aff; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: 500; text-decoration: none; transition: background-color 0.2s; }
        .tag:hover { background-color: #dbeaff; }
        #comment-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px; }
        #comment-form textarea { width: 100%; padding: 12px; font-family: 'Noto Sans SC', sans-serif; font-size: 1rem; border: 1px solid #e0e0e0; border-radius: 8px; resize: vertical; min-height: 80px; outline-color: #2a7aff; }
        #comment-form button { align-self: flex-end; padding: 8px 20px; font-size: 1rem; font-weight: 500; color: #fff; background-color: #2a7aff; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        #comment-form button:hover { background-color: #0056b3; }
        #comment-form button:disabled { background-color: #aaa; cursor: not-allowed; }
        .comment { border-bottom: 1px solid #f0f0f0; padding: 15px 0; }
        .comment:last-child { border-bottom: none; }
        .comment-author { font-weight: 600; color: #444; margin-bottom: 5px; }
        .comment-date { font-size: 0.85rem; color: #999; float: right; }
        .comment-content { color: #555; }
    </style>
</head>
<body>
    <!-- ... (HTML ç»“æ„ä¿æŒä¸å˜) ... -->
    <header class="header">
        <a href="index.html" class="logo">æˆ‘çš„è§†é¢‘</a>
        <form class="search-form" id="search-form">
            <input type="text" id="search-input" placeholder="æœç´¢æ ‡é¢˜æˆ–æ ‡ç­¾..." />
            <button type="submit" aria-label="æœç´¢"><i class="fas fa-search"></i></button>
        </form>
        <div class="user-section">
            <div class="avatar"></div>
            <span>æ¸¸å®¢</span>
        </div>
    </header>

    <main class="main-player-content">
        <div id="player-container">
            <h1 id="video-title">åŠ è½½ä¸­...</h1>
            <div id="video-stats">
                <span id="views-count">-- è§‚çœ‹</span>
                <span id="upload-date">--</span>
            </div>
            <div id="video-wrapper"></div> 
            <p id="video-description"></p>
        </div>
        
        <section id="tags-section">
            <h2>æ ‡ç­¾</h2>
            <div class="tags-container" id="tags-container">
                <p>...</p>
            </div>
        </section>

        <section id="comments-section">
            <h2>è¯„è®º</h2>
            <form id="comment-form">
                <textarea id="comment-input" placeholder="è¾“å…¥å‹å–„çš„è¯„è®º..." required minlength="1"></textarea>
                <button id="comment-submit-btn" type="submit">å‘å¸ƒè¯„è®º</button>
            </form>
            <div id="comments-list">
                <p>...</p>
            </div>
        </section>
    </main>

    <script>
        // --- (å…ƒç´ è·å–, ä¿æŒä¸å˜) ---
        const titleEl = document.getElementById('video-title');
        const statsViewsEl = document.getElementById('views-count');
        const statsDateEl = document.getElementById('upload-date');
        const wrapperEl = document.getElementById('video-wrapper');
        const descEl = document.getElementById('video-description');
        const tagsContainer = document.getElementById('tags-container');
        const commentsList = document.getElementById('comments-list');
        const commentForm = document.getElementById('comment-form');
        const commentInput = document.getElementById('comment-input');
        const commentSubmitBtn = document.getElementById('comment-submit-btn');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        
        let currentVideoId = null;

        function escapeHTML(str) {
            // ... (æ­¤å‡½æ•°ä¿æŒä¸å˜) ...
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        async function loadVideoData() {
            // ... (æ­¤å‡½æ•°ä¿æŒä¸å˜) ...
            try {
                const params = new URLSearchParams(window.location.search);
                const videoId = params.get('id');
                if (!videoId) {
                    titleEl.innerText = 'æœªæ‰¾åˆ°è§†é¢‘ ID';
                    return;
                }
                currentVideoId = videoId;

                const [detailsResponse, countsResponse] = await Promise.all([
                    fetch(`/api/get_video_details?id=${videoId}`),
                    fetch('/api/get_view_counts') 
                ]);

                if (!detailsResponse.ok) throw new Error('æ— æ³•è·å–è§†é¢‘è¯¦æƒ…');
                if (!countsResponse.ok) throw new Error('æ— æ³•è·å–æ’­æ”¾é‡');

                const details = await detailsResponse.json();
                const viewCounts = await countsResponse.json();

                if (details.error) throw new Error(details.details || details.error);
                if (viewCounts.error) throw new Error(viewCounts.details || viewCounts.error);

                const count = viewCounts[videoId] || 0;

                titleEl.innerText = details.title;
                document.title = `æ­£åœ¨æ’­æ”¾ - ${details.title}`;
                statsViewsEl.innerText = `${count} è§‚çœ‹`;
                statsDateEl.innerText = details.upload_date;
                descEl.innerText = details.description || 'æš‚æ— æè¿°ã€‚';

                const videoElement = document.createElement('video');
                videoElement.src = details.signed_play_url;
                videoElement.controls = true;
                videoElement.autoplay = true; 
                videoElement.playsInline = true;
                videoElement.preload = "auto";
                wrapperEl.innerHTML = '';
                wrapperEl.appendChild(videoElement);

                renderTags(details.tags);
                renderComments(details.comments); // <-- è°ƒç”¨ä¿®æ”¹åçš„å‡½æ•°

            } catch (error) {
                titleEl.innerText = 'åŠ è½½è§†é¢‘å¤±è´¥';
                descEl.innerText = 'å¾ˆæŠ±æ­‰ï¼ŒåŠ è½½è§†é¢‘æ—¶é‡åˆ°é”™è¯¯ã€‚';
                console.error('åŠ è½½è§†é¢‘æ•°æ®é”™è¯¯:', error);
            }
        }
        
        function renderTags(tags) {
            // ... (æ­¤å‡½æ•°ä¿æŒä¸å˜) ...
            if (!tags || tags.length === 0) {
                tagsContainer.innerHTML = '<p>æš‚æ— æ ‡ç­¾</p>';
                return;
            }
            tagsContainer.innerHTML = tags.map(tag => {
                const safeTag = escapeHTML(tag);
                return `<a href="index.html?search=${encodeURIComponent(safeTag)}" class="tag">${safeTag}</a>`;
            }).join('');
        }

        // --- (!! å·²ä¿®æ­£ !!) ---
        function renderComments(comments) {
            if (!comments || comments.length === 0) {
                // (ä¿®å¤1) ç»™å ä½ç¬¦æ·»åŠ ä¸€ä¸ªå”¯ä¸€çš„ ID
                commentsList.innerHTML = '<p id="no-comments-placeholder">è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</p>';
                return;
            }
            commentsList.innerHTML = comments.map(comment => {
                return `
                    <div class="comment">
                        <span class="comment-date">${escapeHTML(comment.created_at)}</span>
                        <div class="comment-author">æ¸¸å®¢</div>
                        <p class="comment-content">${escapeHTML(comment.content)}</p>
                    </div>
                `;
            }).join('');
        }
        
        // --- (!! å·²ä¿®æ­£ !!) ---
        function renderNewComment(comment) {
            // (ä¿®å¤2) ä¸å†ä½¿ç”¨ querySelector('p')
            // è€Œæ˜¯ç²¾ç¡®æŸ¥æ‰¾é‚£ä¸ªå ä½ç¬¦ ID
            const placeholder = document.getElementById('no-comments-placeholder');
            
            if (placeholder) {
                // (ä¿®å¤3) å¦‚æœæ‰¾åˆ°äº†å ä½ç¬¦ï¼Œå°±åªåˆ é™¤å®ƒï¼Œè€Œä¸æ˜¯æ¸…ç©ºæ•´ä¸ªåˆ—è¡¨
                placeholder.remove();
            }

            // (ä¸å˜) æ­£å¸¸åˆ›å»ºæ–°è¯„è®º
            const commentHTML = `
                <div class="comment" style="background-color: #f8f9ff;">
                    <span class="comment-date">${escapeHTML(comment.created_at)}</span>
                    <div class="comment-author">æ¸¸å®¢</div>
                    <p class="comment-content">${escapeHTML(comment.content)}</p>
                </div>
            `;
            // (ä¸å˜) æ’å…¥åˆ°é¡¶éƒ¨
            commentsList.insertAdjacentHTML('afterbegin', commentHTML);
        }

        async function handleCommentSubmit(event) {
            // ... (æ­¤å‡½æ•°ä¿æŒä¸å˜) ...
            event.preventDefault();
            if (!currentVideoId) return;
            const content = commentInput.value.trim();
            if (!content) return;
            commentSubmitBtn.disabled = true;
            commentSubmitBtn.innerText = 'å‘å¸ƒä¸­...';
            try {
                const response = await fetch('/api/add_comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        videoId: currentVideoId,
                        content: content
                    })
                });
                if (!response.ok) { throw new Error('å‘å¸ƒå¤±è´¥'); }
                const newComment = await response.json();
                renderNewComment(newComment); // <-- è°ƒç”¨ä¿®æ”¹åçš„å‡½æ•°
                commentInput.value = ''; 
            } catch (error) {
                alert('è¯„è®ºå‘å¸ƒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
                console.error('è¯„è®ºå¤±è´¥:', error);
            } finally {
                commentSubmitBtn.disabled = false;
                commentSubmitBtn.innerText = 'å‘å¸ƒè¯„è®º';
            }
        }

        function handleSearch(event) {
            // ... (æ­¤å‡½æ•°ä¿æŒä¸å˜) ...
            event.preventDefault();
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                window.location.href = `index.html?search=${encodeURIComponent(searchTerm)}`;
            }
        }
        
        // --- (äº‹ä»¶ç›‘å¬, ä¿æŒä¸å˜) ---
        document.addEventListener('DOMContentLoaded', loadVideoData);
        commentForm.addEventListener('submit', handleCommentSubmit);
        searchForm.addEventListener('submit', handleSearch);
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</body>
</html>